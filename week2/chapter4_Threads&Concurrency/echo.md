---
createdAt: 2024-01-27
updatedAt: 2024-01-27
tags:
  - OS
sourceType: Book
---
# 스레드와 동시성

- 스레드는 CPU 이용의 기본 단위
- ID, PC, 레지스터 집합, 스택으로 이루어짐
- 같은 프로세스의 스레드끼리 운영체제 자원 공유

## 동기

- 기존 프로세스와 새로 생성한 프로세스가 해야할 일이 같다면 만드는 것보다 스레드를 만드는게 효율적이라서
## 다중 스레드 장점

- 응답성: 프로그램의 긴 작업 수행 및 봉쇄에도 프로그램 수행이 계속 되기 때문에 응답성 증가
- 자원 공유: 프로세스는 별도의 전달 방식이 필요하지만 스레드는 자동 공유
- 경제성: 스레드간 문맥 교환이 빠르고 생성 비용이 적다.
- 규모 적응성: 다중 처리 구조에서 스레드는 병렬로 처리 가능
# 다중 코어 프로그래밍

- 여러 CPU 사용
- 동시 시스템: 모든 작업이 진행되게 해 둘 이상의 작업 지원(시분할 시스템)
- 병렬 시스템: 실제로 둘 이상의 작업 동시 수행

## 도전과제
- 테스크 인식: 동시 처리 가능한 테스크로 나눌 수 있는 영역 찾기
- 균형: 각 작업이 균등하도록 테스크 나누기
- 데이터 분리: 데이터도 독립적으로 관리
- 데이터 종속성: 둘 이상의 테스크가 의존하지 않도록
- 시험 및 디버깅: 다양한 실행 경로에서 테스트 디버깅 시행

## 병렬 실행 유형

1. 데이터 병렬 실행: 동일한 데이터 부분 집합을 다수 코어에 분배해 연산
2. 테스크 병렬 실행: 테스크를 다수 코어에 분배해 연산을 실행
![[Screenshot 2024-01-27 at 22.57.17.png]]


## 다중 스레드 모델

- 스레드는 사용자 스레드와 커널 스레드로 나누어짐
- 사용자 스레드: 커널 위에서 지원, 커널 지원 없이 관리
- 커널 스레드: OS 직접 지원

## 다대일

- 커널 스레드 1: 사용자 스레드 N
- 관리: 사용자 공간의 스레드 라이브러리
- 단점:
	- 한 스레드가 봉쇄형 시스템 콜을 할 경우 전체 프로세스 봉쇄
	- 한 번에 하나의 스레드만이 커널에 접근 → 멀티 코어에서 병렬 실행 X
	- 그린 스레드가 이 방식 사용

## 일대일

- 커널 1: 사용자 1
- 하나의 스레드가 봉쇄적 시스템 콜을 해도 다른 스레드 실행
- 단점:
	- 커널 스레드를 생성해야해서 시스템 성능 부담

## 다대다

- 커널 N: 사용자 M (N >= M)
- two-level model 사용
- 동시에 1:1도 지원

# 스레드 라이브러리

프로그래머에게 스레드 생성 관리하기 위한 API 제공

- 사용자 공간 라이브러리: 시스템 콜이 아닌 사용자 공간에서 지역 함수 호출
- 커널 수준 라이브러리: 커널 시스템 콜

생성법
- 비동기 스레딩
	- 부모가 자식 스레드 생성 후 부모 실행 재개, 자식과 독립적으로 실행, 데이터 공유 거의 없음
- 동기 스레딩
	- 자식 스레드가 종료되면 부모 스레드 실행, 데이터 공유할 수 있다.

# 암묵적 스레딩

- 스레딩 생성 관리 책임을 컴파일러나 런타임 라이브러리가 가져감

## 스레드풀

- 스레드를 미리 만들어 스레드 풀로 만듬
- 프로세스 시작시 일정 수 스레드로 풀 만들어 둠

- 순서
	- 유휴 스레드
	- 요청 들어오면 깨어남
	- 유휴 스레드가 없으면 생길때까지 대기

- 풀 개수는 코어수, 물리 메모리 용량, 요청 최대 개수 등으로 계산

## Fork Join

- 부모 스레드가 자식 스레드 생성한 다음 자식의 종료를 기다리고 join
- 결과 확인하고 결합 가능
- 동기 버전의 스레드 풀 방식

# 관련 문제들

## Fork Exec 시스템 콜

- 다중 스레드에서 프로세스를 생성하는 fork()를 호출할때
	- 새로운 프로세스는 한 개의 스레드만 가지는 프로세스?
	- 아니면 모든 스레드를 복사한 프로세스?
  - 몇몇 OS는 둘 다 제공
  - 만약 exec를 호출한다면 모든 스레드 복제는 불필요
  - exec 호출하지 않는다면 모든 스레드 복제 필요

## 신호 처리

- 어떤 이벤트가 일어났다는 것을 알려주기 위해 사용
- 동기적 혹은 비동기적으로 전달
- 어쨋든 처리해야함
	- 신호는 특정 이벤트가 일어나야 생성
	- 생성된 신호가 프로세스에 전달
	- 신호가 전달되면 반드시 처리

- 둘 처리기 중 하나에 의해 처리
	- 디폴트
	- 사용자 정의
- 신호 전달 방식
	- 신호가 적용될 스레드에게 전달
	- 모든 스레드에게 전달
	- 몇몇 스레드들에만 선택적으로 전달
	- 특정 스레드가 모든 신호를 전달받도록 지정

### 스레드 취소

취소해야할 스레드 = 목적 스레드

- 비동기식 취소: 한 스레드가 즉시 목적 스레드 종료
- 지연 취소: 목적 스레드가 주기적으로 자기 자신이 종료 되야하는지 점검
### 스레드 로컬장치 TLS

- 스레드들은 프로세스 데이터 공유하는데 자기만 엑세스 할 수 있는 데이터 필요
- 이를 TLS
- 정적 데이터와 유사
- 다만 스레드마다 고유

### 스케줄러 엑티베이션

- 다대다 또는 two - level model을 구현하는 시스템은 중간 자료 구조를 둠
- 이를 경량 프로세스 혹은 LWP라고 부름
- 하나의 커널 스레드에 부속되어있음
- 스케줄 하는 대상은 해당 커널 스레드
- 해당 커널 스레드 봉쇄 → 해당 커널 스레드의 LWP 봉쇄 → 해당 LWP에 부속된 사용자 스레드 봉쇄

- 사용자 스레드 라이브러리와 커널 스레드 통신 방법의 하나는 스케줄러 엑티베이션
- 커널이 응용 프로그램에게 특정 이벤트를 알려주며 이를 upcall이라고 함